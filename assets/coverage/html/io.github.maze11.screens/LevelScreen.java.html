<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LevelScreen.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">core</a> &gt; <a href="index.source.html" class="el_package">io.github.maze11.screens</a> &gt; <span class="el_source">LevelScreen.java</span></div><h1>LevelScreen.java</h1><pre class="source lang-java linenums">package io.github.maze11.screens;

import com.badlogic.ashley.core.ComponentMapper;
import com.badlogic.ashley.core.Entity;
import com.badlogic.ashley.core.EntityListener;
import com.badlogic.ashley.core.EntitySystem;
import com.badlogic.ashley.core.Family;
import com.badlogic.ashley.core.PooledEngine;
import com.badlogic.gdx.Screen;
import com.badlogic.gdx.graphics.Color;
import com.badlogic.gdx.graphics.OrthographicCamera;
import com.badlogic.gdx.maps.MapObject;
import com.badlogic.gdx.maps.objects.RectangleMapObject;
import com.badlogic.gdx.maps.tiled.TiledMap;
import com.badlogic.gdx.physics.box2d.World;
import com.badlogic.gdx.utils.ScreenUtils;
import com.badlogic.gdx.utils.viewport.FitViewport;
import io.github.maze11.MazeGame;
import io.github.maze11.achievements.AchievementManager;
import io.github.maze11.assetLoading.AssetId;
import io.github.maze11.components.PhysicsComponent;
import io.github.maze11.factory.EntityMaker;
import io.github.maze11.fixedStep.FixedStepper;
import io.github.maze11.messages.MessagePublisher;
import io.github.maze11.systems.AttendanceSystem;
import io.github.maze11.systems.AudioSystem;
import io.github.maze11.systems.BobSystem;
import io.github.maze11.systems.GooseSystem;
import io.github.maze11.systems.HiddenWallSystem;
import io.github.maze11.systems.InteractableSystem;
import io.github.maze11.systems.PiSystem;
import io.github.maze11.systems.PlayerSystem;
import io.github.maze11.systems.TimerSystem;
import io.github.maze11.systems.gameState.GameStateSystem;
import io.github.maze11.systems.physics.PhysicsSyncSystem;
import io.github.maze11.systems.physics.PhysicsSystem;
import io.github.maze11.systems.physics.PhysicsToTransformSystem;
import io.github.maze11.systems.physics.SafeBodyDestroy;
import io.github.maze11.systems.rendering.RenderingSystem;
import io.github.maze11.systems.rendering.WorldCameraSystem;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * The screen displayed when the game is running. This is where the world and player can be seen,
 * and most the time is spent by the player.
 */
public class LevelScreen implements Screen {
  private final PooledEngine engine;

  private final TiledMap map;
  private final FitViewport viewport;
  private final OrthographicCamera camera;

  private final FixedStepper fixedStepper;
  private final MessagePublisher messagePublisher;

<span class="nc" id="L60">  private final boolean isDebugging = false;</span>

<span class="nc" id="L62">  public LevelScreen(MazeGame game) {</span>
<span class="nc" id="L63">    AchievementManager.newRound();</span>
<span class="nc" id="L64">    camera = new OrthographicCamera();</span>
<span class="nc" id="L65">    viewport = new FitViewport(16, 12, camera);</span>

<span class="nc" id="L67">    map = game.getAssetLoader().get(AssetId.TILEMAP, TiledMap.class);</span>

<span class="nc" id="L69">    engine = new PooledEngine();</span>
<span class="nc" id="L70">    fixedStepper = new FixedStepper();</span>
<span class="nc" id="L71">    messagePublisher = new MessagePublisher();</span>

<span class="nc" id="L73">    EntityMaker entityMaker = new EntityMaker(engine, game);</span>

<span class="nc" id="L75">    GooseSystem gooseSystem = new GooseSystem(fixedStepper, messagePublisher);</span>
<span class="nc" id="L76">    RenderingSystem renderingSystem = new RenderingSystem(game, camera, map, messagePublisher);</span>

    // Game conditions (win/lose) -&gt; Input -&gt; Sync &amp; Physics -&gt; render (for no input delay)
<span class="nc" id="L79">    List&lt;EntitySystem&gt; systems =</span>
<span class="nc" id="L80">        List.of(</span>
            new GameStateSystem(messagePublisher, game, engine),
            new InteractableSystem(messagePublisher, engine, entityMaker),
            gooseSystem,
            new PlayerSystem(fixedStepper, messagePublisher, game),
            new HiddenWallSystem(fixedStepper, messagePublisher),
            new PhysicsSyncSystem(fixedStepper),
            new PhysicsSystem(fixedStepper, messagePublisher),
            new PhysicsToTransformSystem(fixedStepper),
            new AudioSystem(engine, messagePublisher, game),
<span class="nc" id="L90">            new WorldCameraSystem(camera, game.getBatch()),</span>
            new TimerSystem(messagePublisher),
            new AttendanceSystem(fixedStepper, messagePublisher),
            new AchievementManager(fixedStepper, messagePublisher),
            new BobSystem(fixedStepper, messagePublisher),
            new PiSystem(fixedStepper, messagePublisher),
            renderingSystem);

<span class="nc bnc" id="L98" title="All 2 branches missed.">    for (EntitySystem system : systems) {</span>
<span class="nc" id="L99">      engine.addSystem(system);</span>
<span class="nc" id="L100">    }</span>

<span class="nc" id="L102">    PhysicsSystem physicsSystem = engine.getSystem(PhysicsSystem.class);</span>
    if (isDebugging) {
      World debugWorld = physicsSystem.getWorld();
      renderingSystem.enableDebugging(debugWorld);
    }

<span class="nc" id="L108">    registerPhysicsCleanupListener();</span>

<span class="nc" id="L110">    Map&lt;String, List&lt;Entity&gt;&gt; entities = extractEntities(entityMaker);</span>

    // Extract player
<span class="nc" id="L113">    Entity player = entities.getOrDefault(&quot;player&quot;, List.of()).stream().findFirst().orElse(null);</span>
<span class="nc" id="L114">    gooseSystem.setTarget(player);</span>

    // Create timer (5 minutes = 300 seconds)
<span class="nc" id="L117">    entityMaker.makeTimer(300f);</span>

<span class="nc" id="L119">    entityMaker.makeAttendanceChecker(13);</span>

<span class="nc" id="L121">    System.out.println(&quot;Level Screen created.&quot;);</span>
<span class="nc" id="L122">  }</span>

  private Map&lt;String, List&lt;Entity&gt;&gt; extractEntities(EntityMaker entityMaker) {
<span class="nc" id="L125">    int pixelsToUnit = MazeGame.PIXELS_TO_UNIT;</span>

<span class="nc" id="L127">    Map&lt;String, List&lt;Entity&gt;&gt; groups = new HashMap&lt;&gt;();</span>

    // Walls (Collisions layer)
<span class="nc" id="L130">    var wallsLayer = map.getLayers().get(&quot;Collisions&quot;);</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">    if (wallsLayer != null) {</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">      for (MapObject obj : wallsLayer.getObjects()) {</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (obj instanceof RectangleMapObject rectObj) {</span>
<span class="nc" id="L134">          var rect = rectObj.getRectangle();</span>

<span class="nc" id="L136">          float x = rect.x / pixelsToUnit;</span>
<span class="nc" id="L137">          float y = rect.y / pixelsToUnit;</span>
<span class="nc" id="L138">          float w = rect.width / pixelsToUnit;</span>
<span class="nc" id="L139">          float h = rect.height / pixelsToUnit;</span>

<span class="nc" id="L141">          Entity wall = entityMaker.makeWall(x, y, w, h);</span>
<span class="nc" id="L142">          groups.computeIfAbsent(&quot;wall&quot;, k -&gt; new ArrayList&lt;&gt;()).add(wall);</span>
        }
<span class="nc" id="L144">      }</span>
    }

    // Game Entities (Entities layer)
<span class="nc" id="L148">    var entitiesLayer = map.getLayers().get(&quot;Entities&quot;);</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">    if (entitiesLayer != null) {</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">      for (MapObject obj : entitiesLayer.getObjects()) {</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">        if (!(obj instanceof RectangleMapObject rectObj)) continue;</span>

<span class="nc" id="L153">        var rect = rectObj.getRectangle();</span>
<span class="nc" id="L154">        float x = rect.x / pixelsToUnit;</span>
<span class="nc" id="L155">        float y = rect.y / pixelsToUnit;</span>

<span class="nc" id="L157">        String type = obj.getProperties().get(&quot;type&quot;, String.class);</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">        if (type == null) continue;</span>

        if (isDebugging) {
          System.out.println(&quot;=== Entity Properties ===&quot;);
          var props = obj.getProperties();

          var keys = props.getKeys();
          while (keys.hasNext()) {
            String key = keys.next();
            Object value = props.get(key);
            System.out.printf(&quot; â€¢ %-20s : %s%n&quot;, key, value);
          }
        }

        Entity e =
<span class="nc bnc" id="L173" title="All 12 branches missed.">            switch (type.toLowerCase()) {</span>
<span class="nc" id="L174">              case &quot;player&quot; -&gt; entityMaker.makePlayer(x, y);</span>
<span class="nc" id="L175">              case &quot;goose&quot; -&gt; entityMaker.makeGoose(x, y);</span>
<span class="nc" id="L176">              case &quot;coffee&quot; -&gt; entityMaker.makeCoffee(x, y);</span>
<span class="nc" id="L177">              case &quot;check-in&quot; -&gt; entityMaker.makeCheckInCode(x, y);</span>
<span class="nc" id="L178">              case &quot;bob&quot; -&gt; entityMaker.makeBob(x, y);</span>
<span class="nc" id="L179">              case &quot;glasses&quot; -&gt; entityMaker.makeGlasses(x, y);</span>
<span class="nc" id="L180">              case &quot;exit&quot; -&gt; entityMaker.makeExit(x, y);</span>
<span class="nc" id="L181">              case &quot;pie-slice&quot; -&gt; entityMaker.makePieSlice(x, y);</span>
              case &quot;pressure-plate&quot; -&gt; {
<span class="nc" id="L183">                String triggers = obj.getProperties().get(&quot;triggers&quot;, String.class);</span>
<span class="nc" id="L184">                yield entityMaker.makePressurePlate(x, y, triggers);</span>
              }
              case &quot;false-wall&quot; -&gt; {
<span class="nc" id="L187">                float w = rect.width / pixelsToUnit;</span>
<span class="nc" id="L188">                float h = rect.height / pixelsToUnit;</span>
<span class="nc" id="L189">                String triggeredBy = obj.getProperties().get(&quot;triggeredBy&quot;, String.class);</span>
<span class="nc" id="L190">                yield entityMaker.makeFalseWall(x, y, w, h, triggeredBy);</span>
              }
              case &quot;wall&quot; -&gt; {
<span class="nc" id="L193">                float w = rect.width / pixelsToUnit;</span>
<span class="nc" id="L194">                float h = rect.height / pixelsToUnit;</span>
<span class="nc" id="L195">                yield entityMaker.makeWall(x, y, w, h);</span>
              }
<span class="nc" id="L197">              default -&gt; null;</span>
            };

<span class="nc bnc" id="L200" title="All 2 branches missed.">        if (e != null) {</span>
<span class="nc" id="L201">          groups.computeIfAbsent(type, k -&gt; new ArrayList&lt;&gt;()).add(e);</span>
        }
<span class="nc" id="L203">      }</span>
    }

<span class="nc" id="L206">    return groups;</span>
  }

  @Override
  public void render(float deltaTime) {
<span class="nc" id="L211">    ScreenUtils.clear(Color.BLACK);</span>

<span class="nc" id="L213">    viewport.apply();</span>
<span class="nc" id="L214">    fixedStepper.advanceSimulation(deltaTime);</span>
<span class="nc" id="L215">    engine.update(deltaTime);</span>
<span class="nc" id="L216">  }</span>

  @Override
  public void resize(int width, int height) {
<span class="nc bnc" id="L220" title="All 4 branches missed.">    if (width == 0 || height == 0) return;</span>

<span class="nc" id="L222">    viewport.update(width, height, true);</span>

<span class="nc" id="L224">    RenderingSystem renderSys = engine.getSystem(RenderingSystem.class);</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">    if (renderSys != null) {</span>
<span class="nc" id="L226">      renderSys.resize(width, height);</span>
    }
<span class="nc" id="L228">  }</span>

  @Override
<span class="nc" id="L231">  public void show() {}</span>

  @Override
<span class="nc" id="L234">  public void hide() {}</span>

  @Override
<span class="nc" id="L237">  public void pause() {}</span>

  @Override
<span class="nc" id="L240">  public void resume() {}</span>

  @Override
  public void dispose() {
<span class="nc" id="L244">    engine.removeAllEntities(); // Clean up entities first to trigger physics body removal</span>
<span class="nc" id="L245">    var phys = engine.getSystem(PhysicsSystem.class);</span>
<span class="nc" id="L246">    var audio = engine.getSystem(AudioSystem.class);</span>

<span class="nc bnc" id="L248" title="All 2 branches missed.">    if (phys != null) {</span>
<span class="nc" id="L249">      engine.removeSystem(phys);</span>
    }
<span class="nc bnc" id="L251" title="All 2 branches missed.">    if (audio != null) {</span>
<span class="nc" id="L252">      audio.dispose();</span>
    }

<span class="nc" id="L255">    engine.removeAllEntities();</span>
<span class="nc" id="L256">    System.out.println(&quot;Level screen disposed&quot;);</span>
<span class="nc" id="L257">  }</span>

  private void registerPhysicsCleanupListener() {
<span class="nc" id="L260">    ComponentMapper&lt;PhysicsComponent&gt; physicsMapper =</span>
<span class="nc" id="L261">        ComponentMapper.getFor(PhysicsComponent.class);</span>

<span class="nc" id="L263">    engine.addEntityListener(</span>
<span class="nc" id="L264">        Family.all(PhysicsComponent.class).get(),</span>
<span class="nc" id="L265">        new EntityListener() {</span>
          @Override
<span class="nc" id="L267">          public void entityAdded(Entity e) {}</span>

          @Override
          public void entityRemoved(Entity e) {
<span class="nc" id="L271">            PhysicsComponent phys = physicsMapper.get(e);</span>
<span class="nc bnc" id="L272" title="All 4 branches missed.">            if (phys != null &amp;&amp; phys.body != null) {</span>
<span class="nc" id="L273">              SafeBodyDestroy.request(phys.body);</span>
<span class="nc" id="L274">              phys.body = null;</span>
            }
<span class="nc" id="L276">          }</span>
        });
<span class="nc" id="L278">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>